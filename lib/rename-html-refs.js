// Generated by CoffeeScript 1.10.0
var _parseDOMNode, basename, htmlparser, join, path, renameHtmlReferences;

basename = require('path').basename;

htmlparser = require('htmlparser2');

path = require('path');

join = path.join;

_parseDOMNode = function(node, assetsPath, renamed, cdnPrefix) {
  var fname, i, len, n, newAssetPath, noop, ref, ref1, ref2, ref3, results;
  newAssetPath = null;
  if (node.type === 'tag' && (node.name === 'style' || node.name === 'link')) {
    newAssetPath = node.attribs.href;
  } else if (node.type === 'script' && node.name === 'script') {
    if ((ref = node.attribs) != null ? ref.src : void 0) {
      newAssetPath = node.attribs.src;
    }
  } else if (node.type === 'tag' && node.name === 'img' && node.attribs.src && node.attribs.src !== 'src') {
    newAssetPath = node.attribs.src;
  }
  if (newAssetPath) {
    if (newAssetPath.startsWith('http') || newAssetPath.startsWith('//')) {
      noop = '';
    } else {
      newAssetPath = join(assetsPath, newAssetPath);
      if (renamed[newAssetPath]) {
        fname = cdnPrefix + "/" + (basename(renamed[newAssetPath]));
        if ((ref1 = node.attribs) != null ? ref1.src : void 0) {
          node.attribs.src = fname;
        } else if ((ref2 = node.attribs) != null ? ref2.href : void 0) {
          node.attribs.href = fname;
        }
      } else {
        console.log('skipping', newAssetPath);
      }
    }
  }
  if (node.children) {
    ref3 = node.children;
    results = [];
    for (i = 0, len = ref3.length; i < len; i++) {
      n = ref3[i];
      results.push(_parseDOMNode(n, assetsPath, renamed, cdnPrefix));
    }
    return results;
  }
};

module.exports = renameHtmlReferences = function(filepath, text, assetsPath, renamed, cdnPrefix) {
  var d, handler, i, len, parser, result, updated;
  if (cdnPrefix == null) {
    cdnPrefix = '';
  }
  d = null;
  handler = new htmlparser.DomHandler((function(_this) {
    return function(er, dom) {
      var i, len;
      if (er) {
        throw new Error(er);
      } else {
        for (i = 0, len = dom.length; i < len; i++) {
          d = dom[i];
          _parseDOMNode(d, assetsPath, renamed, cdnPrefix);
        }
      }
      return d = dom;
    };
  })(this));
  parser = new htmlparser.Parser(handler);
  parser.parseComplete(text);
  result = d;
  updated = '';
  for (i = 0, len = result.length; i < len; i++) {
    d = result[i];
    updated += htmlparser.DomUtils.getOuterHTML(d);
  }
  return updated;
};
